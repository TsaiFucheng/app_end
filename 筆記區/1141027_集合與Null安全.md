# Dart 集合型別與 Null Safety

> 課程日期：114/10/27
> 對應檔案：`1141027.txt`

---

## 教學重點

### 1. StringBuffer 字串緩衝區

```dart
StringBuffer sb = StringBuffer();
sb.writeln('Test');              // 寫入並換行
sb.writeAll(['x', 'y', 'z']);    // 寫入多個元素
sb.write(100);                   // 寫入單一值
sb.writeCharCode(65);            // 寫入字元碼 (65 = 'A')
print(sb);                       // Test\nxyz100A
```

### 2. 變數修飾詞比較

| 修飾詞 | 說明 | 可重新賦值 | 初始化時機 |
|--------|------|:---------:|------------|
| `var` | 自動推論型別 | ✓ (同型別) | 宣告時 |
| `dynamic` | 動態型別 | ✓ (任意型別) | 任何時候 |
| `final` | 執行時常數 | ✗ | 執行時 |
| `const` | 編譯時常數 | ✗ | 編譯時 |

```dart
var x = 1;           // 推論為 int，之後只能賦值 int
// x = "hello";      // 錯誤！

dynamic y = 1;       // 可改為任意型別
y = "hello";         // OK

final name = 'Bob';  // 可用變數初始化
// name = 'Alice';   // 錯誤！

const pi = 3.14159;  // 必須是編譯時常數
// const b = r * pi; // 錯誤！r 不是常數
```

### 3. num 型別

```dart
// num 是 int 和 double 的父類別
num value = 3;      // 可以是 int
value = 3.14;       // 也可以改為 double
```

---

## List (有序陣列)

### 基本宣告

```dart
var list1 = [1, 2, 3];           // List<int>
List list2 = [1, 2, 3];          // List<dynamic>
List<int> list3 = [1, 2, 3];     // 明確宣告型別
List<int> list4 = [];            // 空 List
var list5 = List.filled(3, 0);   // [0, 0, 0]
var constantList = const [1, 2, 3];  // 不可修改的常數 List
```

### 常用操作

```dart
var list = [1, 2, 3];

// 新增/刪除/修改
list.add(4);           // [1, 2, 3, 4]
list.remove(4);        // [1, 2, 3]
list[0] = 10;          // [10, 2, 3]

// 查詢
print(list.length);    // 3
print(list.contains(2)); // true

// 反轉
print(list.reversed);  // (3, 2, 10) - Iterable
var reversed = List.from(list.reversed);  // [3, 2, 10]

// 排序
list.sort();                               // 預設排序
list.sort((a, b) => a.compareTo(b));       // 自訂排序

// 洗牌
list.shuffle();

// 合併
var merged = list1 + list2;
```

### 篩選與遍歷

```dart
var n = [1, 2, 3, 4, 5];

// 篩選奇數
n.where((i) => i.isOdd).forEach((i) => print(i));  // 1 3 5

// for 迴圈
for (int i = 0; i < list.length; i++) {
  print(list[i]);
}

// for-in 迴圈
for (int item in list) {
  print(item);
}
```

### 二維 List

```dart
List<List<int>> matrix = [];
matrix.add([1, 2, 3]);
matrix.add([4, 5, 6]);
print(matrix[0][1]);  // 2
```

### 混合型別 List

```dart
List list = [123, 'ABC', true];
List<dynamic> list2 = [1, true, 'xyz', 1.3];

for (int i = 0; i < list.length; i++) {
  print('List[$i] type is ${list[i].runtimeType}');
}
// List[0] type is int
// List[1] type is String
// List[2] type is bool
```

---

## Set (無序不重複集合)

### 基本宣告

```dart
var set1 = {1, 2, 3};        // Set<int>
var set2 = {};               // Map<dynamic, dynamic> (注意！)
var set3 = <int>{};          // Set<int>
```

### 特性：自動去重

```dart
var list = [1, 2, 3, 1, 2, 3];
var set = {1, 2, 3, 1, 2, 3};
print(list.length);  // 6
print(set.length);   // 3
```

### 集合運算

```dart
var setA = {'A', 'B', 'C', 'D', 'E'};
var setB = {'A', 'B', '1', '2', '3'};

// 差集
print(setA.difference(setB));   // {C, D, E}

// 交集
print(setA.intersection(setB)); // {A, B}

// 聯集
print(setA.union(setB));        // {A, B, C, D, E, 1, 2, 3}
```

### 轉換為 List

```dart
List x = Set<String>.from(setA).toList();
```

---

## Map (鍵值對)

### 基本宣告

```dart
// 方式一：直接初始化
var map1 = {
  'first': 'A',
  'second': 'B',
  'third': 'C'
};

// 方式二：使用 Map()
var map2 = Map();
map2['first'] = 'A';

// 常數 Map (不可修改)
Map<int, String> constMap = const {1: 'A', 2: 'B'};
```

### 常用操作

```dart
var map = {'a': 1, 'b': 2};

// 新增/修改
map['c'] = 3;

// 取值
print(map['a']);  // 1

// 合併
map.addAll({'d': 4, 'e': 5});
```

### 遍歷

```dart
Map<String, int> grades = {'Ada': 28, 'Bob': 25, 'Cox': 30};

grades.forEach((key, value) {
  print('Key: $key, Value: $value');
});
```

### 巢狀結構遍歷

```dart
List<Map<String, int>> grades = [
  {'Ada': 60, 'Bob': 80, 'Helen': 70},
  {'Ada': 75, 'Bob': 70, 'Helen': 90},
  {'Ada': 70, 'Bob': 60, 'Helen': 80}
];

int sum = 0;
grades.forEach((map) {
  map.forEach((k, v) => sum += v);
});
print(sum);  // 655
```

---

## List / Map 互轉

```dart
class Customer {
  String name;
  int age;
  Customer(this.name, this.age);
}

void main() {
  Map map = {'Ada': 23, 'Bob': 25, 'Cox': 22};

  // Map → List
  var list = map.entries.map((e) => Customer(e.key, e.value)).toList();

  // List → Map
  var newMap = Map.fromIterable(list,
    key: (i) => i.name,
    value: (i) => i.age
  );
}
```

---

## Null Safety

### 基本概念

```dart
int x;      // 非 nullable，必須初始化才能使用
int? y;     // nullable，預設值為 null

// x = null;  // 錯誤！
y = null;    // OK
```

### 操作符

| 操作符 | 說明 | 範例 |
|--------|------|------|
| `?` | 宣告可為 null | `int? x;` |
| `!` | 強制解包 (null assertion) | `y!` |
| `?.` | 安全呼叫 | `object?.method()` |
| `??` | null 合併運算 | `x ?? defaultValue` |
| `late` | 延遲初始化 | `late int x;` |

### 使用範例

```dart
int x = 100;
int? y;

// 賦值
y = x;        // OK (int → int?)
x = y!;       // 需要 null check (int? → int)

// 方法呼叫
int? getValue() => -3;
int z = getValue()!.abs();  // 需要 ! 才能呼叫 abs()
```

### 可為 null 的 List

```dart
List<int>? b;           // 整個 List 可為 null
List<int?> c = [1, 2, null];  // 元素可為 null
```

### late 關鍵字

```dart
class A {
  late int value;  // 延遲初始化，使用前必須賦值
}

A obj = A();
obj.value = 10;   // 使用前賦值
print(obj.value); // 10
```

### 函式參數 Null Safety

```dart
double calculate(double? x) {
  if (x != null) {
    return x + 1;
  } else {
    return 0;
  }
}

double? input;
double result = calculate(input);  // 0.0
```

---

## 學習要點總結

- [ ] 區分 `var`, `dynamic`, `final`, `const` 的差異
- [ ] 掌握 List 的新增、刪除、排序、篩選操作
- [ ] 了解 Set 的去重特性和集合運算
- [ ] 使用 Map 的鍵值對操作和遍歷
- [ ] 理解 Null Safety 的 `?`, `!`, `late` 用法
- [ ] 掌握 List 和 Map 的互相轉換
- [ ] 使用 `forEach` 遍歷集合
- [ ] 了解 `StringBuffer` 的效能優勢
