# Flutter 國際化 - BMI 計算器 v3

> 課程日期：114/10/13
> 對應專案：`1141013bmi_v3/`

---

## 教學重點

### 1. Flutter 國際化 (i18n) 配置

#### 步驟 1：安裝 Flutter Intl 插件
```
Android Studio → File → Settings → Plugins → 搜索 "Flutter Intl" → Install → Restart IDE
```

#### 步驟 2：加入依賴
在 `pubspec.yaml` 中加入：
```yaml
dependencies:
  flutter_localizations:
    sdk: flutter
```

#### 步驟 3：初始化專案
```
Tools → Flutter Intl → Initialize for the Project
```
執行後會產生：
- `lib/generated/` - 自動生成的本地化程式碼
- `lib/l10n/intl_en.arb` - 英文翻譯檔

#### 步驟 4：新增語言
```
Tools → Flutter Intl → Add Locale → 輸入 "zh"
```
會產生：
- `lib/l10n/intl_zh.arb` - 中文翻譯檔
- `lib/generated/intl/messages_zh.dart` - 中文訊息檔

### 2. 設定 MaterialApp 國際化

```dart
import 'package:flutter_localizations/flutter_localizations.dart';
import 'generated/l10n.dart';

class MyApp extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      localizationsDelegates: [
        S.delegate,                              // 自動生成的 delegate
        GlobalWidgetsLocalizations.delegate,    // Flutter Widget 本地化
        GlobalMaterialLocalizations.delegate,   // Material 元件本地化
        GlobalCupertinoLocalizations.delegate   // Cupertino 元件本地化
      ],
      supportedLocales: S.delegate.supportedLocales,  // 支援的語言列表
      // ...
    );
  }
}
```

### 3. 使用國際化字串

#### ARB 檔案格式
`lib/l10n/intl_en.arb`:
```json
{
  "title": "BMI Calculator",
  "height1": "Please input your height",
  "status01": "too light",
  "status02": "normal",
  "status03": "too heavy"
}
```

`lib/l10n/intl_zh.arb`:
```json
{
  "title": "BMI計算機",
  "height1": "請輸入身高",
  "status01": "過輕",
  "status02": "正常",
  "status03": "過重"
}
```

#### 在程式中使用
```dart
// 使用 S.of(context).key 取得翻譯字串
Text("${S.of(context).title}");           // 顯示 "BMI計算機" 或 "BMI Calculator"
Text("${S.of(context).height1}");         // 顯示 "請輸入身高" 或 "Please input your height"
```

### 4. GestureDetector 手勢偵測

```dart
GestureDetector(
  onTap: () => Navigator.push(
    context,
    MaterialPageRoute(builder: (context) => MyHomePage(title: "..."))
  ),
  child: Container(
    // 讓整個 Container 可點擊
    width: 200,
    height: 200,
    decoration: BoxDecoration(...),
  ),
),
```

**常用手勢：**
| 屬性 | 手勢類型 |
|------|---------|
| `onTap` | 點擊 |
| `onDoubleTap` | 雙擊 |
| `onLongPress` | 長按 |
| `onPanUpdate` | 拖曳 |
| `onScaleUpdate` | 縮放 |

### 5. Timer 取消機制

```dart
Timer? t;  // 可為 null 的 Timer

@override
void initState() {
  super.initState();
  t = Timer(Duration(seconds: 3), () {
    Navigator.push(context, ...);
  });
}

// 手動跳轉時取消 Timer
ElevatedButton(
  onPressed: () {
    t?.cancel();  // 取消計時器，避免重複導航
    Navigator.push(context, ...);
  },
  child: Text("開始"),
),
```

### 6. PopScope 返回鍵處理

```dart
PopScope(
  canPop: false,  // 禁止預設返回行為
  onPopInvokedWithResult: (bool didPop, Object? result) async {
    if (didPop) {
      return;  // 如果已經 pop 了，直接返回
    }
    // 自訂返回行為：返回到 Screen1
    Navigator.push(context, MaterialPageRoute(builder: (context) => Screen1()));
  },
  child: Scaffold(
    // ...
  ),
),
```

**PopScope vs WillPopScope：**
- `WillPopScope` 已在 Flutter 3.12 後棄用
- 改用 `PopScope` 處理返回鍵事件

### 7. 多字型配置

專案中使用兩種自訂字型：
```yaml
# pubspec.yaml
flutter:
  fonts:
    - family: kai          # 標楷體
      fonts:
        - asset: fonts/kai.ttf
    - family: Li           # 隸書體
      fonts:
        - asset: fonts/Li.ttf
```

使用方式：
```dart
// 標題使用 kai 字型
Text("${S.of(context).firstTitle}",
  style: TextStyle(fontFamily: "kai"),
),

// 按鈕使用 Li 字型
Text("${S.of(context).firstButton}",
  style: TextStyle(fontFamily: "Li"),
),
```

### 8. 國際化字串比較注意事項

當使用國際化字串進行條件判斷時，需使用 `S.of(context)` 而非硬編碼：
```dart
Color getTextColor(String? s1) {
  // ✅ 正確：使用國際化字串比較
  if (s1 == "${S.of(context).status02}") {
    return Colors.green;
  }
  else if (s1 == "${S.of(context).status01}") {
    return Colors.amberAccent;
  }
  else if (s1 == "${S.of(context).status03}") {
    return Colors.red;
  }
  // ❌ 錯誤：硬編碼字串（無法適應語言切換）
  // if (s1 == "正常") { ... }
  return Colors.white;
}
```

### 9. flutter_intl 配置

在 `pubspec.yaml` 底部需加入：
```yaml
flutter_intl:
  enabled: true
```
這會讓 Flutter Intl 插件自動監測 ARB 檔案變更並重新生成程式碼。

---

## 專案檔案結構

```
lib/
├── main.dart                 # 主程式
├── generated/
│   ├── l10n.dart            # 自動生成的 S 類別
│   └── intl/
│       ├── messages_all.dart
│       ├── messages_en.dart  # 英文訊息
│       └── messages_zh.dart  # 中文訊息
└── l10n/
    ├── intl_en.arb          # 英文翻譯 (JSON 格式)
    └── intl_zh.arb          # 中文翻譯 (JSON 格式)
```

---

## v2 vs v3 功能比較

| 功能 | v2 | v3 |
|------|:--:|:--:|
| 啟動頁面 | ✓ | ✓ |
| 頁面導航 | ✓ | ✓ |
| AlertDialog | ✓ | ✓ |
| 國際化 (i18n) | ✗ | ✓ |
| GestureDetector | ✗ | ✓ |
| Timer 取消 | ✗ | ✓ |
| PopScope 返回處理 | ✗ | ✓ |
| 多語言支援 | ✗ | ✓ (中/英) |

---

## 國際化字串對照表

| Key | 英文 (en) | 中文 (zh) |
|-----|----------|----------|
| `firstTitle` | My BMI App | 我的BMI程式 |
| `firstButton` | Start | 開始 |
| `title` | BMI Calculator | BMI計算機 |
| `height1` | Please input your height | 請輸入身高 |
| `weight1` | Please input your weight | 請輸入體重 |
| `calculate` | Calculate | 計算 |
| `error_text` | Cannot be empty | 不得為空 |
| `warning` | Warning | 警告 |
| `popup_message` | Height/weight cannot be empty! | 身高體重不得為空! |
| `result1` | Your BMI= | 您的BMI= |
| `status00` | Your body status is | 您的體重狀態為： |
| `status01` | too light | 過輕 |
| `status02` | normal | 正常 |
| `status03` | too heavy | 過重 |
| `button1` | Confirm | 確定 |

---

## 使用的 Widget 清單

| Widget / 類別 | 用途 |
|--------------|------|
| `S` | 國際化字串類別 (自動生成) |
| `LocalizationsDelegate` | 本地化代理 |
| `GestureDetector` | 手勢偵測 |
| `PopScope` | 返回鍵處理 |
| `Timer` | 計時器 (需手動取消) |

---

## 學習要點總結

- [ ] 了解 Flutter Intl 插件的安裝與初始化
- [ ] 掌握 ARB 檔案格式與多語言設定
- [ ] 使用 `S.of(context).key` 取得翻譯字串
- [ ] 設定 MaterialApp 的 localizationsDelegates
- [ ] 使用 `GestureDetector` 為任意 Widget 添加手勢
- [ ] 了解 `Timer?.cancel()` 避免重複導航
- [ ] 使用 `PopScope` 自訂返回鍵行為
- [ ] 理解國際化在動態字串比較中的注意事項
- [ ] 配置多種自訂字型 (kai, Li)
- [ ] 在 pubspec.yaml 加入 flutter_intl 設定
